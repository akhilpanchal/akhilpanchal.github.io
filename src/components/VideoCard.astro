---
import { Badge } from "@/components/ui/badge"
import { Image } from 'astro:assets';

interface Props {
  videoId: string;
  title: string;
  releaseDate?: Date | string;
  description?: string;
  category?: 'original' | 'cover';
}

const { videoId, title, releaseDate, description, category } = Astro.props;

// Generate YouTube thumbnail URL (high quality)
const thumbnailUrl = `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`;

// Format date if provided
let formattedDate = '';
if (releaseDate) {
  const date = releaseDate instanceof Date ? releaseDate : new Date(releaseDate);
  formattedDate = new Intl.DateTimeFormat('en-US', {
    month: 'short',
    year: 'numeric',
  }).format(date);
}

// Category badge variants
const categoryVariants = {
  original: 'default' as const,
  cover: 'secondary' as const,
};

// Generate a unique ID for this card
const cardId = `video-card-${videoId}`;
---

<article 
  class="video-card group rounded-lg border border-border bg-card text-card-foreground shadow-sm transition-all hover:shadow-md" 
  id={cardId}
  data-video-id={videoId}
  data-video-title={title}
>
  <button
    type="button"
    class="video-card-button block w-full text-left cursor-pointer"
    data-video-id={videoId}
    data-video-title={title}
    aria-label={`Play ${title}`}
  >
    <!-- Thumbnail Container -->
    <div class="relative aspect-video overflow-hidden rounded-t-lg bg-muted">
      <Image 
        src={thumbnailUrl} 
        alt={`${title} thumbnail`}
        class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
        inferSize
      />
      
      <!-- Play Button Overlay -->
      <div class="absolute inset-0 flex items-center justify-center bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
        <div class="play-button-wrapper transform transition-transform duration-300 group-hover:scale-110">
          <svg 
            class="w-16 h-16 text-white drop-shadow-lg" 
            fill="currentColor" 
            viewBox="0 0 24 24"
          >
            <path d="M8 5v14l11-7z"/>
          </svg>
        </div>
      </div>
      
      <!-- Category Badge -->
      {category && (
        <div class="absolute top-2 right-2">
          <Badge variant={categoryVariants[category]}>
            {category.charAt(0).toUpperCase() + category.slice(1)}
          </Badge>
        </div>
      )}
    </div>
    
    <!-- Video Info -->
    <div class="p-4 space-y-2">
      <h3 class="font-semibold text-foreground line-clamp-2 group-hover:text-primary transition-colors">
        {title}
      </h3>
      
      {formattedDate && (
        <p class="text-sm text-muted-foreground">
          {formattedDate}
        </p>
      )}
      
      {description && (
        <p class="text-sm text-muted-foreground line-clamp-2">
          {description}
        </p>
      )}
    </div>
  </button>

  <!-- Now Playing Indicator -->
  <div class="now-playing-indicator hidden absolute top-2 left-2">
    <Badge variant="default" className="bg-green-500 hover:bg-green-500 animate-pulse">
      <span class="flex items-center gap-1">
        <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24">
          <path d="M8 5v14l11-7z"/>
        </svg>
        Now Playing
      </span>
    </Badge>
  </div>
</article>

<script>
  import { playVideo, subscribeToPlayerState, getPlayerState } from '../lib/videoPlayerState';

  // Handle video card clicks
  function initializeVideoCards() {
    const buttons = document.querySelectorAll('.video-card-button');
    
    buttons.forEach((button) => {
      const videoId = button.getAttribute('data-video-id');
      const videoTitle = button.getAttribute('data-video-title');
      
      if (!videoId || !videoTitle) return;
      
      button.addEventListener('click', (e) => {
        e.preventDefault();
        playVideo(videoId, videoTitle);
      });
    });
  }

  // Update "Now Playing" indicators
  function updateNowPlayingIndicators() {
    const state = getPlayerState();
    const allCards = document.querySelectorAll('.video-card');
    
    allCards.forEach((card) => {
      const videoId = card.getAttribute('data-video-id');
      const indicator = card.querySelector('.now-playing-indicator');
      
      if (indicator) {
        if (state.isOpen && state.currentVideoId === videoId) {
          indicator.classList.remove('hidden');
        } else {
          indicator.classList.add('hidden');
        }
      }
    });
  }

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', () => {
    initializeVideoCards();
    updateNowPlayingIndicators();
    
    // Subscribe to state changes
    subscribeToPlayerState(() => {
      updateNowPlayingIndicators();
    });
  });

  // Re-initialize after Astro view transitions
  document.addEventListener('astro:after-swap', () => {
    initializeVideoCards();
    updateNowPlayingIndicators();
  });
</script>

<style>
  .video-card {
    transition: all 0.3s ease;
  }
  
  .play-button-wrapper {
    transform: scale(1);
    transition: transform 0.3s ease;
  }
  
  .video-card:hover .play-button-wrapper {
    transform: scale(1.1);
  }
  
  /* Ensures smooth image loading */
  .video-thumbnail {
    will-change: transform;
  }
</style>
